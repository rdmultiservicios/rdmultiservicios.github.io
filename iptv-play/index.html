<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IPTV Smart TV Web App</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body {
    background: #111;
    color: #fff;
    font-family: 'Segoe UI', sans-serif;
}
.nav-tabs .nav-link {
    color: #fff;
}
.nav-tabs .nav-link.active {
    background-color: #222;
    border-color: #444;
}
#videoPlayer {
    background: black;
    width: 100%;
    height: 400px;
    border-radius: 8px;
}
#carouselContainer {
    padding: 20px 0;
    overflow-x: auto;
    white-space: nowrap;
}
.channel-card {
    display: inline-block;
    width: 200px;
    margin: 0 10px;
    cursor: pointer;
    transition: transform 0.3s, border 0.3s;
}
.channel-card img {
    width: 100%;
    border-radius: 10px;
}
.channel-card.focused {
    transform: scale(1.2);
    border: 3px solid #f39c12;
}
</style>
</head>
<body>

<nav class="navbar navbar-dark bg-dark p-2 d-flex justify-content-between">
    <span class="navbar-brand mb-0 h1">IPTV Smart TV</span>
    <input id="searchInput" class="form-control w-25" type="search" placeholder="Buscar">
</nav>

<div class="container-fluid mt-3">
    <div class="row">
        <div class="col-md-9">
            <video id="videoPlayer" controls autoplay></video>
            <ul class="nav nav-tabs mt-3" id="categoryTabs"></ul>
            <div id="carouselContainer" class="mt-2"></div>
        </div>
        <div class="col-md-3">
            <h5>Favoritos</h5>
            <ul id="favoritesList" class="list-group mb-3"></ul>
            <h5>Historial</h5>
            <ul id="historyList" class="list-group"></ul>
        </div>
    </div>
</div>

<script>
let channels = [];
let categories = new Set();
let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
let history = JSON.parse(localStorage.getItem('history')) || [];
let focusedIndex = 0;
let currentCategory = '';
let channelsByCategory = [];

// Cargar archivo M3U
async function loadM3U() {
    const response = await fetch('channels.m3u'); // Debe estar en la misma carpeta
    const data = await response.text();

    const lines = data.split('\n');
    for(let i=0;i<lines.length;i++){
        if(lines[i].startsWith('#EXTINF:')){
            const infoLine = lines[i];
            const url = lines[i+1].trim();

            const nameMatch = infoLine.match(/tvg-name="([^"]+)"/);
            const logoMatch = infoLine.match(/tvg-logo="([^"]+)"/);
            const categoryMatch = infoLine.match(/group-title="([^"]+)"/);

            const channel = {
                name: nameMatch ? nameMatch[1] : 'Sin Nombre',
                logo: logoMatch ? logoMatch[1] : '',
                category: categoryMatch ? categoryMatch[1] : 'Otros',
                url: url
            };
            channels.push(channel);
            categories.add(channel.category);
        }
    }

    setupCategories();
    displayChannels([...categories][0]);
    renderFavorites();
    renderHistory();
}

// Crear pestañas de categorías
function setupCategories(){
    const tabs = document.getElementById('categoryTabs');
    categories.forEach((cat, idx)=>{
        const li = document.createElement('li');
        li.className = 'nav-item';
        li.innerHTML = `<button class="nav-link ${idx===0?'active':''}" onclick="displayChannels('${cat}')">${cat}</button>`;
        tabs.appendChild(li);
    });
}

// Mostrar canales en carrusel
function displayChannels(category, filter=''){
    currentCategory = category;
    const container = document.getElementById('carouselContainer');
    container.innerHTML = '';

    channelsByCategory = channels.filter(c=>c.category===category && c.name.toLowerCase().includes(filter.toLowerCase()));

    channelsByCategory.forEach((c,idx)=>{
        const card = document.createElement('div');
        card.className = 'channel-card';
        card.dataset.index = idx;
        card.innerHTML = `
            <img src="${c.logo}" alt="${c.name}">
            <p class="text-center mt-1">${c.name}</p>
        `;
        card.onclick = () => playChannel(c.url, c.name);
        container.appendChild(card);
    });

    focusedIndex = 0;
    updateFocus();
}

// Reproducir canal
function playChannel(url,name){
    const player = document.getElementById('videoPlayer');
    player.src = url;
    player.play();
    addToHistory(name);
}

// Favoritos
function toggleFavorite(name){
    if(favorites.includes(name)) favorites = favorites.filter(f=>f!==name);
    else favorites.push(name);
    localStorage.setItem('favorites',JSON.stringify(favorites));
    renderFavorites();
}

// Historial
function addToHistory(name){
    if(!history.includes(name)){
        history.unshift(name);
        if(history.length>10) history.pop();
        localStorage.setItem('history',JSON.stringify(history));
        renderHistory();
    }
}

// Render favoritos
function renderFavorites(){
    const container = document.getElementById('favoritesList');
    container.innerHTML='';
    favorites.forEach(f=>{
        const li = document.createElement('li');
        li.className='list-group-item';
        li.textContent=f;
        container.appendChild(li);
    });
}

// Render historial
function renderHistory(){
    const container = document.getElementById('historyList');
    container.innerHTML='';
    history.forEach(h=>{
        const li = document.createElement('li');
        li.className='list-group-item';
        li.textContent=h;
        container.appendChild(li);
    });
}

// Búsqueda
document.getElementById('searchInput').addEventListener('input',(e)=>{
    displayChannels(currentCategory,e.target.value);
});

// Navegación con teclado
document.addEventListener('keydown',(e)=>{
    const cards = document.querySelectorAll('#carouselContainer .channel-card');
    if(!cards.length) return;

    if(e.key==='ArrowRight') focusedIndex = (focusedIndex+1)%cards.length;
    if(e.key==='ArrowLeft') focusedIndex = (focusedIndex-1+cards.length)%cards.length;
    if(e.key==='Enter') cards[focusedIndex].click();

    updateFocus();
});

// Actualizar foco en carrusel
function updateFocus(){
    const cards = document.querySelectorAll('#carouselContainer .channel-card');
    if(cards.length===0) return;

    cards.forEach(c=>c.classList.remove('focused'));
    const focusedCard = cards[focusedIndex];
    focusedCard.classList.add('focused');

    // Centrar tarjeta enfocada
    const container = document.getElementById('carouselContainer');
    const containerWidth = container.offsetWidth;
    const cardLeft = focusedCard.offsetLeft;
    const cardWidth = focusedCard.offsetWidth;
    const scrollPos = cardLeft - containerWidth/2 + cardWidth/2;
    container.scrollTo({left: scrollPos, behavior:'smooth'});
}

loadM3U();
</script>

</body>
</html>
