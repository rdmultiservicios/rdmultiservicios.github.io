<!DOCTYPE html>
<html lang="es" data-bs-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mi IPTV Web Mejorada</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Video.js -->
  <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
  <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
  <!-- Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />

  <style>
    /* Canales grid - desktop */
    #listaCanales {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      max-height: calc(100vh - 240px);
      overflow-y: auto;
      overflow-x: hidden;
    }
    #listaCanales > div.canal-item img {
      width: 100%;
      height: 100px;
      object-fit: contain;
      border-radius: 4px;
    }
    /* Favoritos y últimos vistos */
    #favoritosList, #ultimosVistosList {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding-bottom: 5px;
      margin-bottom: 15px;
    }
    #favoritosList > div, #ultimosVistosList > div {
      min-width: 80px;
      cursor: pointer;
      text-align: center;
    }
    #favoritosList > div img, #ultimosVistosList > div img {
      width: 100%;
      height: 70px;
      object-fit: contain;
      border-radius: 4px;
      border: 2px solid transparent;
    }
    #favoritosList > div.favorito-activo img {
      border-color: #ffc107;
    }

    /* Móvil: grid 4 columnas, scroll horizontal */
    @media (max-width: 767.98px) {
      #listaCanales {
        grid-template-columns: repeat(4, 1fr);
        max-height: none;
        overflow-y: hidden;
        overflow-x: auto;
        white-space: nowrap;
      }
      #listaCanales > div.canal-item {
        min-width: 120px;
        display: inline-block;
      }
      #listaCanales > div.canal-item img {
        height: 80px;
      }

      /* Navbar fijo arriba */
      nav.navbar {
        position: fixed;
        top: 0;
        width: 100%;
        z-index: 1030;
      }

      /* Contenido con padding para navbar fijo */
      .container-fluid {
        padding-top: 70px;
      }

      /* Reordenar contenido móvil */
      .container-fluid > .row {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .col-lg-6.col-md-8.col-12.mb-4 { order: 1; }    /* video */
      #epgInfo { order: 2; margin-top: 10px; }        /* EPG */
      .col-lg-3.d-none.d-lg-block {                   /* publicidad visible en móvil */
        order: 3;
        display: block !important;
        width: 100%;
      }
      .col-lg-3.col-md-4.col-12.mb-4 { order: 4; }    /* canales */
      /* Botones grandes para móvil */
      #favoritosList > div, #ultimosVistosList > div {
        min-width: 90px;
      }
    }

    /* Footer simple */
    footer {
      background-color: var(--bs-body-bg);
      text-align: center;
      padding: 15px 10px;
      border-top: 1px solid #ddd;
      margin-top: 1rem;
      font-size: 0.9rem;
      color: var(--bs-body-color);
    }

    /* Botón PiP */
    #pipBtn {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg bg-body-tertiary px-3">
    <a class="navbar-brand" href="#">IPTV Mejorada</a>
    <button
      class="navbar-toggler"
      type="button"
      data-bs-toggle="collapse"
      data-bs-target="#navbarContent"
      aria-controls="navbarContent"
      aria-expanded="false"
      aria-label="Toggle navigation"
    >
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="#">Inicio</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Canales</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Películas</a></li>
      </ul>

      <select id="selectLista" class="form-select w-auto me-2" title="Selecciona lista de canales">
        <option value="canales.m3u" selected>Lista Principal</option>
        <option value="otra_lista.m3u">Otra Lista</option>
      </select>

      <button id="toggleTheme" class="btn btn-outline-secondary my-2 my-lg-0" title="Cambiar tema">
        <i class="bi bi-moon-fill"></i>
      </button>
    </div>
  </nav>

  <div class="container-fluid mt-3">
    <div class="row">
      <!-- Canales -->
      <div class="col-lg-3 col-md-4 col-12 mb-4">
        <div class="mb-2">
          <input
            type="text"
            id="buscar"
            class="form-control"
            placeholder="Buscar canal..."
            aria-label="Buscar canal"
          />
        </div>
        <div class="mb-2">
          <select id="filtroGrupo" class="form-select" aria-label="Filtrar por grupo">
            <option value="">Todos los grupos</option>
          </select>
        </div>

        <div id="favoritosList" aria-label="Canales favoritos" tabindex="0" role="list"></div>
        <div id="ultimosVistosList" aria-label="Últimos canales vistos" tabindex="0" role="list"></div>

        <div id="listaCanales" aria-label="Listado de canales"></div>
      </div>

      <!-- Video + PiP -->
      <div class="col-lg-6 col-md-8 col-12 mb-4">
        <div id="canalActual" class="mb-2 fw-bold" aria-live="polite" aria-atomic="true"></div>
        <video
          id="player"
          class="video-js vjs-default-skin vjs-16-9 w-100"
          controls
          preload="auto"
          playsinline
          crossorigin="anonymous"
        ></video>
        <button id="pipBtn" class="btn btn-outline-primary" title="Activar modo Picture in Picture">PiP</button>

        <div class="epg mt-3" id="epgInfo" aria-live="polite" aria-atomic="true">Cargando programación...</div>
      </div>

      <!-- Publicidad Adsense (solo en desktop) -->
      <div class="col-lg-3 d-none d-lg-block">
        <ins
          class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-xxxxxxxxxxxxxxxx"
          data-ad-slot="yyyyyyyyyy"
          data-ad-format="auto"
          data-full-width-responsive="true"
          aria-label="Publicidad Adsense"
        ></ins>
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer>
    &copy; 2025 Mi IPTV Web Mejorada - Todos los derechos reservados
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Variables globales
    let canales = [];
    let favoritos = JSON.parse(localStorage.getItem("favoritos")) || [];
    let ultimosVistos = JSON.parse(localStorage.getItem("ultimosVistos")) || [];

    const listaCanales = document.getElementById("listaCanales");
    const filtroGrupo = document.getElementById("filtroGrupo");
    const buscar = document.getElementById("buscar");
    const epgInfo = document.getElementById("epgInfo");
    const canalActual = document.getElementById("canalActual");
    const favoritosList = document.getElementById("favoritosList");
    const ultimosVistosList = document.getElementById("ultimosVistosList");
    const selectLista = document.getElementById("selectLista");

    const player = videojs("player", {
      autoplay: false,
      controls: true,
      preload: "auto",
      fluid: true,
      controlBar: {
        volumePanel: {inline: false}
      }
    });

    // Debounce para búsqueda
    function debounce(fn, delay) {
      let timeout;
      return (...args) => {
        clearTimeout(timeout);
        timeout = setTimeout(() => fn(...args), delay);
      };
    }

    // Cambiar tema claro/oscuro
    document.getElementById("toggleTheme").addEventListener("click", () => {
      const html = document.documentElement;
      const current = html.getAttribute("data-bs-theme");
      if (current === "light") {
        html.setAttribute("data-bs-theme", "dark");
        document.getElementById("toggleTheme").innerHTML = '<i class="bi bi-sun-fill"></i>';
      } else {
        html.setAttribute("data-bs-theme", "light");
        document.getElementById("toggleTheme").innerHTML = '<i class="bi bi-moon-fill"></i>';
      }
    });

    // Cargar canales de lista m3u
    async function cargarCanales(urlLista) {
      canales = [];
      filtroGrupo.innerHTML = `<option value="">Todos los grupos</option>`;
      listaCanales.innerHTML = `<p>Cargando canales...</p>`;
      try {
        const res = await fetch(urlLista);
        const texto = await res.text();
        const lineas = texto.split("\n");
        let grupoSet = new Set();

        for (let i = 0; i < lineas.length; i++) {
          if (lineas[i].startsWith("#EXTINF")) {
            const info = lineas[i];
            const url = lineas[i + 1]?.trim();
            if (!url) continue;
            const nombre = info.match(/,(.*)/)?.[1] || "Canal";
            const logo = info.match(/tvg-logo=\"(.*?)\"/)?.[1] || "";
            const grupo = info.match(/group-title=\"(.*?)\"/)?.[1] || "General";
            grupoSet.add(grupo);
            canales.push({ nombre, logo, grupo, url });
          }
        }

        grupoSet.forEach(g => {
          const opt = document.createElement("option");
          opt.value = g;
          opt.textContent = g;
          filtroGrupo.appendChild(opt);
        });

        renderFavoritos();
        renderUltimosVistos();
        renderCanales();
      } catch (e) {
        listaCanales.innerHTML = "<p>Error cargando canales</p>";
      }
    }

    // Renderizar canales filtrados y búsqueda
    function renderCanales() {
      const filtro = buscar.value.trim().toLowerCase();
      const grupo = filtroGrupo.value;

      const filtrados = canales.filter(c => {
        const enGrupo = grupo === "" || c.grupo === grupo;
        const enBusqueda = c.nombre.toLowerCase().includes(filtro);
        return enGrupo && enBusqueda;
      });

      if (filtrados.length === 0) {
        listaCanales.innerHTML = "<p>No se encontraron canales.</p>";
        return;
      }

      listaCanales.innerHTML = "";
      filtrados.forEach(c => {
        const div = document.createElement("div");
        div.className = "canal-item";
        div.setAttribute("tabindex", "0");
        div.setAttribute("role", "button");
        div.setAttribute("aria-label", `Reproducir canal ${c.nombre}`);

        div.innerHTML = `
          <img loading="lazy" src="${c.logo}" alt="Logo ${c.nombre}" />
          <div class="text-truncate" title="${c.nombre}">${c.nombre}</div>
          <button class="btn btn-sm btn-warning mt-1" aria-label="Añadir o quitar ${c.nombre} de favoritos">
            <i class="bi bi-star${isFavorito(c) ? '-fill' : ''}"></i>
          </button>
        `;

        // Click en canal para reproducir
        div.addEventListener("click", () => {
          reproducir(c.url, c.nombre);
        });
        // Click en botón favorito
        div.querySelector("button").addEventListener("click", (e) => {
          e.stopPropagation();
          toggleFavorito(c);
          renderCanales();
          renderFavoritos();
        });

        listaCanales.appendChild(div);
      });
    }

    // ¿Es favorito?
    function isFavorito(canal) {
      return favoritos.some(f => f.nombre === canal.nombre);
    }

    // Toggle favorito
    function toggleFavorito(canal) {
      const index = favoritos.findIndex(f => f.nombre === canal.nombre);
      if (index === -1) {
        favoritos.push(canal);
      } else {
        favoritos.splice(index, 1);
      }
      localStorage.setItem("favoritos", JSON.stringify(favoritos));
    }

    // Render favoritos
    function renderFavoritos() {
      favoritosList.innerHTML = "";
      if (favoritos.length === 0) {
        favoritosList.innerHTML = "<small>No hay favoritos.</small>";
        return;
      }
      favoritos.forEach(c => {
        const div = document.createElement("div");
        div.setAttribute("tabindex", "0");
        div.setAttribute("role", "button");
        div.setAttribute("aria-label", `Reproducir canal favorito ${c.nombre}`);
        div.innerHTML = `<img loading="lazy" src="${c.logo}" alt="Logo ${c.nombre}"/><small>${c.nombre}</small>`;
        div.addEventListener("click", () => reproducir(c.url, c.nombre));
        favoritosList.appendChild(div);
      });
    }

    // Render últimos vistos
    function renderUltimosVistos() {
      ultimosVistosList.innerHTML = "";
      if (ultimosVistos.length === 0) {
        ultimosVistosList.innerHTML = "<small>No hay canales vistos recientemente.</small>";
        return;
      }
      ultimosVistos.forEach(c => {
        const div = document.createElement("div");
        div.setAttribute("tabindex", "0");
        div.setAttribute("role", "button");
        div.setAttribute("aria-label", `Reproducir canal visto recientemente ${c.nombre}`);
        div.innerHTML = `<img loading="lazy" src="${c.logo || 'https://via.placeholder.com/100x70?text=Canal'}" alt="Logo ${c.nombre}"/><small>${c.nombre}</small>`;
        div.addEventListener("click", () => reproducir(c.url, c.nombre));
        ultimosVistosList.appendChild(div);
      });
    }

    // Reproducir canal, guardar últimos vistos y cargar EPG
    function reproducir(url, nombre) {
      player.src({ type: "application/x-mpegURL", src: url });
      player.play();
      canalActual.textContent = `Reproduciendo: ${nombre}`;

      // Guardar en últimos vistos sin duplicados
      ultimosVistos = ultimosVistos.filter(c => c.nombre !== nombre);
      const logoCanal = canales.find(c => c.nombre === nombre)?.logo || "";
      ultimosVistos.unshift({ nombre, url, logo: logoCanal });
      if (ultimosVistos.length > 10) ultimosVistos.pop();
      localStorage.setItem("ultimosVistos", JSON.stringify(ultimosVistos));
      renderUltimosVistos();

      cargarEPG(nombre);
    }

    // Cargar y mostrar EPG formateado, resaltar programa actual
    async function cargarEPG(nombreCanal) {
      epgInfo.textContent = "Cargando programación...";
      try {
        const res = await fetch("epg.xml");
        const texto = await res.text();
        const parser = new DOMParser();
        const xml = parser.parseFromString(texto, "application/xml");
        const programas = xml.querySelectorAll("programme");
        const ahora = new Date();

        let html = "";
        programas.forEach((p) => {
          const canal = p.getAttribute("channel");
          if (!canal.toLowerCase().includes(nombreCanal.toLowerCase())) return;
          const inicioStr = p.getAttribute("start").substring(0, 12);
          const finStr = p.getAttribute("stop").substring(0, 12);
          const inicio = parseEPGDate(inicioStr);
          const fin = parseEPGDate(finStr);
          const titulo = p.querySelector("title")?.textContent || "";

          const activo = ahora >= inicio && ahora <= fin;
          html += `<div style="background:${activo ? '#d1e7dd' : 'transparent'};padding:4px;border-radius:4px;margin-bottom:3px;">
            <strong>${titulo}</strong> (${formatTime(inicio)} - ${formatTime(fin)})
          </div>`;
        });

        epgInfo.innerHTML = html || "Sin programación disponible.";
      } catch (e) {
        epgInfo.textContent = "No se pudo cargar la programación.";
      }
    }
    function parseEPGDate(str) {
      const y = str.substring(0,4);
      const m = str.substring(4,6) - 1;
      const d = str.substring(6,8);
      const h = str.substring(8,10);
      const min = str.substring(10,12);
      return new Date(y, m, d, h, min);
    }
    function formatTime(date) {
      return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    // Evento búsqueda con debounce
    buscar.addEventListener("input", debounce(renderCanales, 300));
    filtroGrupo.addEventListener("change", renderCanales);
    selectLista.addEventListener("change", () => {
      cargarCanales(selectLista.value);
    });

    // Picture in Picture
    document.getElementById("pipBtn").addEventListener("click", async () => {
      const videoEl = player.tech(true).el();
      if (!document.pictureInPictureElement) {
        try {
          await videoEl.requestPictureInPicture();
        } catch {
          alert("Tu navegador no soporta PiP");
        }
      } else {
        await document.exitPictureInPicture();
      }
    });

    // Inicializar
    cargarCanales(selectLista.value);
  </script>
</body>
</html>
