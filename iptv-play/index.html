<!DOCTYPE html>
<html lang="es" data-bs-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mi IPTV Web</title>

  <!-- Bootstrap 5 -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- Video.js -->
  <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
  <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>

  <!-- Icons -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    rel="stylesheet"
  />

  <style>
    /* Estilos canales */

    #listaCanales {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-auto-rows: 1fr;
      gap: 10px;
      max-height: calc(100vh - 140px); /* Ajusta para navbar + inputs */
      overflow-y: auto;
      overflow-x: hidden;
    }

    #listaCanales > div.canal-item img {
      width: 100%;
      height: 100px;
      object-fit: contain;
    }

    /* Móvil: scroll horizontal y grid 4x4 */
    @media (max-width: 767.98px) {
      #listaCanales {
        grid-template-columns: repeat(4, 1fr);
        grid-auto-rows: auto;
        max-height: none;
        overflow-y: hidden;
        overflow-x: auto;
        white-space: nowrap;
      }
      #listaCanales > div.canal-item {
        min-width: 120px;
        display: inline-block;
      }
    }

    /* EPG styling */
    .epg {
      font-size: 0.9rem;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <!-- Navbar responsive -->
  <nav class="navbar navbar-expand-lg bg-body-tertiary px-3">
    <a class="navbar-brand" href="#">IPTV</a>
    <button
      class="navbar-toggler"
      type="button"
      data-bs-toggle="collapse"
      data-bs-target="#navbarContent"
      aria-controls="navbarContent"
      aria-expanded="false"
      aria-label="Toggle navigation"
    >
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="#">Inicio</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Canales</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Películas</a></li>
      </ul>
      <button id="toggleTheme" class="btn btn-outline-secondary my-2 my-lg-0">
        <i class="bi bi-moon-fill"></i>
      </button>
    </div>
  </nav>

  <!-- Contenido Principal -->
  <div class="container-fluid mt-3">
    <div class="row">
      <!-- Columna Izquierda -->
      <div class="col-lg-3 col-md-4 col-12 mb-4">
        <input
          type="text"
          id="buscar"
          class="form-control mb-2"
          placeholder="Buscar canal..."
        />
        <select id="filtroGrupo" class="form-select mb-3">
          <option value="">Todos los grupos</option>
        </select>
        <div id="listaCanales"></div>
      </div>

      <!-- Columna Central -->
      <div class="col-lg-6 col-md-8 col-12 mb-4">
        <video
          id="player"
          class="video-js vjs-default-skin vjs-16-9 w-100"
          controls
          preload="auto"
        ></video>
        <div class="epg mt-3" id="epgInfo">Cargando programación...</div>
      </div>

      <!-- Columna Derecha -->
      <div class="col-lg-3 d-none d-lg-block">
        <!-- Adsense -->
        <ins
          class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-xxxxxxxxxxxxxxxx"
          data-ad-slot="yyyyyyyyyy"
          data-ad-format="auto"
          data-full-width-responsive="true"
        ></ins>
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Dark/Light mode toggle
    document.getElementById("toggleTheme").addEventListener("click", function () {
      const html = document.documentElement;
      const current = html.getAttribute("data-bs-theme");
      html.setAttribute("data-bs-theme", current === "light" ? "dark" : "light");
      this.innerHTML =
        current === "light"
          ? '<i class="bi bi-sun-fill"></i>'
          : '<i class="bi bi-moon-fill"></i>';
    });

    const listaCanales = document.getElementById("listaCanales");
    const filtroGrupo = document.getElementById("filtroGrupo");
    const buscar = document.getElementById("buscar");
    const epgInfo = document.getElementById("epgInfo");

    const player = videojs("player", {
      autoplay: false,
      controls: true,
      preload: "auto",
    });

    let canales = [];

    // Cargar canales.m3u
    async function cargarCanales() {
      const res = await fetch("canales.m3u");
      const texto = await res.text();
      const lineas = texto.split("\n");
      let grupoSet = new Set();

      for (let i = 0; i < lineas.length; i++) {
        if (lineas[i].startsWith("#EXTINF")) {
          const info = lineas[i];
          const url = lineas[i + 1]?.trim();
          const nombre = info.match(/,(.*)/)?.[1] || "Canal";
          const logo = info.match(/tvg-logo=\"(.*?)\"/)?.[1] || "";
          const grupo = info.match(/group-title=\"(.*?)\"/)?.[1] || "General";
          grupoSet.add(grupo);
          canales.push({ nombre, logo, grupo, url });
        }
      }

      // Llenar filtro de grupo
      grupoSet.forEach((g) => {
        const opt = document.createElement("option");
        opt.value = g;
        opt.textContent = g;
        filtroGrupo.appendChild(opt);
      });

      renderCanales();
    }

    function renderCanales() {
      const filtro = buscar.value.toLowerCase();
      const grupoSel = filtroGrupo.value;
      listaCanales.innerHTML = "";

      canales
        .filter((c) => {
          return (
            c.nombre.toLowerCase().includes(filtro) &&
            (grupoSel === "" || c.grupo === grupoSel)
          );
        })
        .forEach((canal) => {
          const div = document.createElement("div");
          div.className = "canal-item card p-1";
          div.style.cursor = "pointer";
          div.title = canal.nombre;
          div.onclick = () => reproducir(canal.url, canal.nombre);
          div.innerHTML = `
            <img src="${canal.logo}" alt="${canal.nombre}" />
            <p class="text-center small mb-0">${canal.nombre}</p>
          `;
          listaCanales.appendChild(div);
        });
    }

    function reproducir(url, nombre) {
      player.src({ type: "application/x-mpegURL", src: url });
      player.play();
      cargarEPG(nombre);
    }

    // Cargar EPG XML (demo simple)
    async function cargarEPG(nombreCanal) {
      try {
        const res = await fetch("epg.xml");
        const texto = await res.text();
        const parser = new DOMParser();
        const xml = parser.parseFromString(texto, "application/xml");
        const programas = xml.querySelectorAll("programme");

        let html = "";
        programas.forEach((p) => {
          const canal = p.getAttribute("channel");
          if (canal.toLowerCase().includes(nombreCanal.toLowerCase())) {
            const inicio = p.getAttribute("start");
            const fin = p.getAttribute("stop");
            const titulo = p.querySelector("title")?.textContent || "";
            html += `<div><strong>${titulo}</strong> (${inicio} - ${fin})</div>`;
          }
        });

        epgInfo.innerHTML = html || "Sin programación disponible.";
      } catch (e) {
        epgInfo.textContent = "No se pudo cargar la programación.";
      }
    }

    buscar.addEventListener("input", renderCanales);
    filtroGrupo.addEventListener("change", renderCanales);

    cargarCanales();
  </script>
</body>
</html>
