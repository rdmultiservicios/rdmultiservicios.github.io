<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IPTV Player - WinTV Style</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background-color: #111; color: #fff; }
    .video-container { position: relative; width: 100%; padding-top: 56.25%; }
    video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; }
    .channel-list { max-height: 80vh; overflow-y: auto; }
    .channel-btn img { border-radius: 3px; }
    .channel-btn span { cursor: pointer; }
  </style>
</head>
<body>

<div class="container-fluid">
  <div class="row vh-100">
    <!-- Sidebar canales -->
    <div class="col-md-3 bg-dark p-3 channel-list">
      <h5>üì∫ Canales</h5>
      <input type="text" class="form-control mb-3" id="search" placeholder="Buscar canal...">
      <div id="channelButtons"></div>
      <hr>
      <h6>‚≠ê Favoritos</h6>
      <div id="favorites"></div>
    </div>

    <!-- Reproductor -->
    <div class="col-md-9 p-0">
      <div class="video-container">
        <video id="video" controls autoplay></video>
      </div>
      <div class="d-flex justify-content-between p-3 bg-dark">
        <button class="btn btn-outline-light" onclick="togglePip()">üì∫ Modo PiP</button>
        <button class="btn btn-outline-light" onclick="goBack()">‚è™ Volver canal anterior</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
  const video = document.getElementById('video');
  let lastChannel = '';
  let channels = [];

  async function loadM3U() {
    try {
      const response = await fetch('channels.m3u');
      const text = await response.text();
      channels = parseM3U(text);
      renderChannels();
      renderFavorites();
      if (channels.length > 0) {
        playStream(channels[0].url, channels[0].name);
      }
    } catch (error) {
      console.error("Error cargando el archivo M3U:", error);
    }
  }

  function parseM3U(data) {
    const lines = data.split('\n');
    const parsed = [];
    for (let i = 0; i < lines.length; i++) {
      if (lines[i].startsWith('#EXTINF')) {
        const nameMatch = lines[i].match(/,(.*)$/);
        const logoMatch = lines[i].match(/tvg-logo="(.*?)"/);
        const name = nameMatch ? nameMatch[1].trim() : 'Canal sin nombre';
        const logo = logoMatch ? logoMatch[1] : '';
        const url = lines[i + 1]?.trim();
        if (url && url.startsWith('http')) {
          parsed.push({ name, url, logo });
        }
      }
    }
    return parsed;
  }

  function playStream(url, name) {
    if (video.src) lastChannel = video.src;
    if (Hls.isSupported()) {
      const hls = new Hls();
      hls.loadSource(url);
      hls.attachMedia(video);
      hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
      video.src = url;
      video.addEventListener('loadedmetadata', () => video.play());
    } else {
      alert('Tu navegador no soporta este tipo de video.');
    }
  }

  function togglePip() {
    if (document.pictureInPictureElement) {
      document.exitPictureInPicture();
    } else {
      video.requestPictureInPicture().catch(err => console.log(err));
    }
  }

  function goBack() {
    if (lastChannel) playStream(lastChannel);
  }

  function renderChannels() {
    const container = document.getElementById('channelButtons');
    const search = document.getElementById('search').value.toLowerCase();
    container.innerHTML = '';
    channels
      .filter(ch => ch.name.toLowerCase().includes(search))
      .forEach(ch => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-outline-light w-100 mb-2 text-start channel-btn';
        btn.innerHTML = `
          <img src="${ch.logo || 'https://via.placeholder.com/20'}" width="24" class="me-2">
          ${ch.name}
          <span class="float-end" onclick="event.stopPropagation(); addFavorite('${ch.name}', '${ch.url}', '${ch.logo}')">‚≠ê</span>
        `;
        btn.onclick = () => playStream(ch.url, ch.name);
        container.appendChild(btn);
      });
  }

  function addFavorite(name, url, logo) {
    let favs = JSON.parse(localStorage.getItem('favorites') || '[]');
    if (!favs.find(f => f.name === name)) {
      favs.push({ name, url, logo });
      localStorage.setItem('favorites', JSON.stringify(favs));
      renderFavorites();
    }
  }

  function renderFavorites() {
    const favs = JSON.parse(localStorage.getItem('favorites') || '[]');
    const container = document.getElementById('favorites');
    container.innerHTML = '';
    favs.forEach(ch => {
      const btn = document.createElement('button');
      btn.className = 'btn btn-warning w-100 mb-2 text-start channel-btn';
      btn.innerHTML = `
        <img src="${ch.logo || 'https://via.placeholder.com/20'}" width="24" class="me-2">
        ${ch.name}
      `;
      btn.onclick = () => playStream(ch.url, ch.name);
      container.appendChild(btn);
    });
  }

  document.getElementById('search').addEventListener('input', renderChannels);
  window.onload = loadM3U;
</script>

</body>
</html>
