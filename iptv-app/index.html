<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TV360 - En Vivo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    :root {
      --bg-color: #ffffff;
      --text-color: #333333;
      --epg-bg: #f5f5f5;
      --channel-bg: #fafafa;
      --highlight-color: #0d6efd;
      --card-bg: #fff;
      --card-text: #444;
      --nav-bg: #fff;
      --footer-bg: #f2f2f2;
    }
    [data-theme="dark"] {
      --bg-color: #121212;
      --text-color: #f1f1f1;
      --epg-bg: #1e1e1e;
      --channel-bg: #1a1a1a;
      --highlight-color: #0d6efd;
      --card-bg: #2a2a2a;
      --card-text: #ccc;
      --nav-bg: #1a1a1a;
      --footer-bg: #1e1e1e;
    }

    body, html {
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* NAVBAR */
    nav.navbar {
      background-color: var(--nav-bg);
      transition: background-color 0.3s ease;
    }
    .navbar-brand {
      font-weight: bold;
      color: var(--highlight-color);
      font-size: 1.5rem;
      transition: color 0.3s ease;
    }
    .form-control {
      background-color: var(--epg-bg);
      border: none;
      color: var(--text-color);
      border-radius: 20px;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    .navbar-nav .nav-link {
      color: var(--text-color);
      transition: color 0.3s ease;
    }
    .navbar-nav .nav-link:hover {
      color: var(--highlight-color);
    }

    .theme-toggle-btn {
      background: none;
      border: none;
      color: var(--text-color);
      font-size: 1.2rem;
      cursor: pointer;
      transition: color 0.3s ease;
    }
    .theme-toggle-btn:hover {
      color: var(--highlight-color);
    }

    .container-main {
      padding: 1rem 2rem;
    }

    #epgContainer,
    #videoWrapper {
      height: 450px;
    }
    #epgContainer {
      background-color: var(--epg-bg);
      padding: 1rem;
      overflow-y: auto;
      transition: background-color 0.3s ease;
    }
    #epgContainer h5 {
      color: var(--highlight-color);
      font-weight: 600;
      margin-bottom: 1rem;
      border-bottom: 1px solid var(--highlight-color);
      padding-bottom: 0.5rem;
      transition: color 0.3s ease, border-color 0.3s ease;
    }
    #epgList {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #epgList li {
      padding: 0.4rem 0;
      font-size: 0.95rem;
      border-bottom: 1px solid var(--channel-bg);
      transition: border-color 0.3s ease;
    }
    #epgList li:last-child {
      border-bottom: none;
    }

    #videoWrapper {
      position: relative;
      background-color: black;
      overflow: hidden;
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background-color: black;
      opacity: 1;
      transition: opacity 0.5s ease;
    }

    #channelGroupsList {
      margin-top: 1.5rem;
    }
    .group-block {
      margin-bottom: 2rem;
    }
    .group-title {
      font-size: 1.2rem;
      font-weight: 600;
      color: var(--highlight-color);
      margin-bottom: 0.8rem;
      transition: color 0.3s ease;
    }
    .channel-scroll {
      white-space: nowrap;
      overflow-x: auto;
      padding-bottom: 0.5rem;
      scrollbar-width: thin;
      scrollbar-color: var(--highlight-color) transparent;
    }
    .channel-scroll::-webkit-scrollbar {
      height: 8px;
    }
    .channel-scroll::-webkit-scrollbar-thumb {
      background: var(--highlight-color);
      border-radius: 10px;
    }

    .channel-card {
      display: inline-block;
      width: 140px;
      margin-right: 0.75rem;
      cursor: pointer;
      background: transparent;
      transition: transform 0.2s ease, filter 0.2s ease;
      text-align: center;
      outline-offset: 2px;
    }
    .channel-card:hover,
    .channel-card:focus {
      transform: scale(1.05);
      filter: brightness(1.1);
      outline: 2px solid var(--highlight-color);
      outline-offset: 0;
    }
    .channel-card.active {
      transform: scale(1.05);
      filter: brightness(1.2);
      outline: 2px solid var(--highlight-color);
      outline-offset: 0;
    }
    .channel-card img {
      width: 140px;
      height: 84px;
      object-fit: cover;
      border-radius: 8px;
      background-color: var(--card-bg);
      transition: background-color 0.3s ease;
    }
    .channel-card .card-title {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: var(--card-text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      transition: color 0.3s ease;
    }
    .channel-card:hover .card-title,
    .channel-card.active .card-title {
      color: var(--highlight-color);
    }

    #fileLabel {
      display: inline-block;
      padding: 6px 12px;
      background-color: var(--highlight-color);
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      user-select: none;
      margin-left: 10px;
      transition: background-color 0.3s ease;
    }
    #fileLabel:hover {
      background-color: #084cd9;
    }
    #fileInput {
      display: none;
    }

    #loadingSpinner {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none;
      z-index: 10;
      color: var(--highlight-color);
      font-weight: 700;
      font-size: 1.5rem;
    }

    @media (max-width: 991.98px) {
      #epgContainer, #videoWrapper {
        height: auto;
      }
    }

    /* FOOTER */
    footer.footer {
      background-color: var(--footer-bg);
      color: var(--text-color);
      padding: 1rem 2rem;
      text-align: center;
      transition: background-color 0.3s ease, color 0.3s ease;
      margin-top: 2rem;
      font-size: 0.9rem;
    }
    footer.footer a {
      color: var(--text-color);
      text-decoration: none;
      transition: color 0.3s ease;
    }
    footer.footer a:hover {
      color: var(--highlight-color);
    }
  </style>
</head>
<body>

  <!-- NAVBAR con menú -->
  <nav class="navbar navbar-expand-lg px-3" role="navigation" aria-label="Menú principal">
    <div class="container-fluid">
      <a class="navbar-brand" href="#" tabindex="0">TV360</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMenu"
        aria-controls="navbarMenu" aria-expanded="false" aria-label="Alternar navegación">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarMenu">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0" role="menubar">
          <li class="nav-item" role="none"><a class="nav-link" href="#" role="menuitem" tabindex="0">Inicio</a></li>
          <li class="nav-item" role="none"><a class="nav-link" href="#" role="menuitem" tabindex="0">Canales</a></li>
          <li class="nav-item" role="none"><a class="nav-link" href="#" role="menuitem" tabindex="0">Acerca de</a></li>
          <li class="nav-item" role="none"><a class="nav-link" href="#" role="menuitem" tabindex="0">Contacto</a></li>
        </ul>

        <input
          class="form-control me-3 w-50"
          type="text"
          placeholder="Buscar canal..."
          id="searchInput"
          autocomplete="off"
          aria-label="Buscar canal"
        />

        <label id="fileLabel" for="fileInput" tabindex="0" role="button" aria-label="Cargar archivo M3U">📂 Cargar M3U</label>
        <input type="file" id="fileInput" accept=".m3u,.txt" aria-describedby="fileLabel" />

        <button class="theme-toggle-btn" id="themeToggleBtn" title="Alternar tema" aria-pressed="false" aria-label="Alternar tema">🌙</button>
      </div>
    </div>
  </nav>

  <!-- Loading Spinner -->
  <div id="loadingSpinner" role="status" aria-live="polite" aria-atomic="true">Cargando...</div>

  <!-- CONTENIDO PRINCIPAL -->
  <div class="container-fluid container-main">
    <div class="row">
      <div class="col-lg-4 col-12 mb-3 mb-lg-0">
        <div id="epgContainer" aria-live="polite" aria-atomic="true" aria-label="Programación del canal">
          <h5>Programación</h5>
          <ul id="epgList"></ul>
        </div>
      </div>
      <div class="col-lg-8 col-12">
        <div id="videoWrapper">
          <video id="livePlayer" controls aria-label="Reproductor de video en vivo"></video>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-12">
        <div id="channelGroupsList" aria-label="Lista de grupos de canales"></div>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <footer class="footer">
    <div>
      © 2025 TV360. Todos los derechos reservados.
    </div>
    <div>
      <a href="#">Política de Privacidad</a> | <a href="#">Términos de servicio</a> | <a href="#">Ayuda</a>
    </div>
  </footer>

  <script>
    // Variables globales controladas
    let channels = [];
    let groupedChannels = {};
    let currentHls = null;
    let currentChannelCard = null;
    let currentChannel = null;

    // DOM references
    const video = document.getElementById("livePlayer");
    const epgList = document.getElementById("epgList");
    const channelGroupsList = document.getElementById("channelGroupsList");
    const searchInput = document.getElementById("searchInput");
    const loadingSpinner = document.getElementById("loadingSpinner");
    const themeToggleBtn = document.getElementById("themeToggleBtn");
    const fileInput = document.getElementById("fileInput");

    // --- UTILIDADES ---

    // Mostrar u ocultar spinner de carga
    function toggleLoading(show) {
      loadingSpinner.style.display = show ? "block" : "none";
    }

    // Limpia contenido de un elemento
    function clearElement(el) {
      while (el.firstChild) {
        el.removeChild(el.firstChild);
      }
    }

    // Debounce para funciones que se llaman con frecuencia (como input)
    function debounce(fn, delay) {
      let timeoutId;
      return (...args) => {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => fn(...args), delay);
      };
    }

    // Guardar estado en localStorage
    function saveToLocalStorage(key, value) {
      try {
        localStorage.setItem(key, JSON.stringify(value));
      } catch (e) {
        console.warn("No se pudo guardar en localStorage:", e);
      }
    }

    // Leer estado de localStorage
    function readFromLocalStorage(key, defaultValue) {
      try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : defaultValue;
      } catch (e) {
        return defaultValue;
      }
    }

    // Sanitizar texto para evitar XSS básico (solo texto plano)
    function sanitizeText(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Parsear archivo M3U a objeto JSON con canales
    function parseM3U(text) {
      const lines = text.split(/\r?\n/);
      const parsedChannels = [];
      let currentChannel = null;

      for (const line of lines) {
        const trimmedLine = line.trim();
        if (!trimmedLine) continue;

        if (trimmedLine.startsWith('#EXTINF:')) {
          // Parsear metadata
          const metadata = trimmedLine.substring(8).split(',');
          let group = '';
          let logo = '';
          let name = '';

          // Extraer grupo y logo con regex
          const groupMatch = trimmedLine.match(/group-title="([^"]*)"/i);
          const logoMatch = trimmedLine.match(/tvg-logo="([^"]*)"/i);
          if (groupMatch) group = groupMatch[1];
          if (logoMatch) logo = logoMatch[1];

          name = metadata.slice(1).join(',').trim();

          currentChannel = { group, logo, name, url: '' };
        } else if (trimmedLine.startsWith('#')) {
          // Otros comentarios ignorados
          continue;
        } else if (currentChannel) {
          currentChannel.url = trimmedLine;
          parsedChannels.push(currentChannel);
          currentChannel = null;
        }
      }
      return parsedChannels;
    }

    // --- MANEJO DEL REPRODUCTOR ---

    // Inicializar o reutilizar instancia HLS para reproducir canal
    function playStream(url) {
      if (currentHls) {
        currentHls.destroy();
        currentHls = null;
      }

      if (Hls.isSupported()) {
        currentHls = new Hls();
        currentHls.loadSource(url);
        currentHls.attachMedia(video);
        currentHls.on(Hls.Events.ERROR, (event, data) => {
          console.error("HLS.js error:", data);
          if (data.fatal) {
            showError(`Error fatal en la reproducción del stream: ${data.type}`);
            currentHls.destroy();
            currentHls = null;
          }
        });
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = url;
      } else {
        showError("Su navegador no soporta reproducción de streams HLS.");
      }
      video.play().catch(err => {
        console.warn("Error al iniciar reproducción automática:", err);
      });
    }

    // Reproducir canal seleccionado
    function playChannel(channel, cardElement) {
      if (!channel || !channel.url) {
        showError("URL inválida para este canal.");
        return;
      }

      // Actualizar estado visual
      if (currentChannelCard) {
        currentChannelCard.classList.remove("active");
      }
      cardElement.classList.add("active");
      currentChannelCard = cardElement;
      currentChannel = channel;

      clearEpg();
      toggleLoading(true);
      playStream(channel.url);
      fetchEpg(channel.url);

      // Guardar canal actual
      saveToLocalStorage("selectedChannel", channel);
    }

    // --- UI y renderización ---

    // Crear tarjeta individual de canal (retorna elemento)
    function createChannelCard(channel) {
      const card = document.createElement("div");
      card.className = "channel-card";
      card.tabIndex = 0;
      card.setAttribute("role", "button");
      card.setAttribute("aria-label", `Reproducir canal ${sanitizeText(channel.name)}`);

      // Logo o placeholder
      const img = document.createElement("img");
      img.src = channel.logo || "https://via.placeholder.com/140x84?text=No+Logo";
      img.alt = `${sanitizeText(channel.name)} logo`;
      img.loading = "lazy";
      card.appendChild(img);

      // Nombre canal
      const title = document.createElement("div");
      title.className = "card-title";
      title.textContent = channel.name;
      card.appendChild(title);

      // Evento click y teclado
      card.addEventListener("click", () => playChannel(channel, card));
      card.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          playChannel(channel, card);
        }
      });

      return card;
    }

    // Renderizar grupo con canales filtrados
    function renderChannelGroup(groupName, channels) {
      if (!channels.length) return null;

      const groupDiv = document.createElement("div");
      groupDiv.className = "group-block";
      groupDiv.setAttribute("data-group", groupName);

      const groupTitle = document.createElement("h4");
      groupTitle.className = "group-title";
      groupTitle.textContent = groupName || "Sin grupo";
      groupDiv.appendChild(groupTitle);

      const channelContainer = document.createElement("div");
      channelContainer.className = "channel-scroll";

      channels.forEach(channel => {
        const card = createChannelCard(channel);
        channelContainer.appendChild(card);
      });

      groupDiv.appendChild(channelContainer);
      return groupDiv;
    }

    // Renderizar todos los grupos (usado en carga inicial y búsqueda)
    function renderAllGroups(filteredChannels = null) {
      clearElement(channelGroupsList);

      const toGroup = filteredChannels || channels;

      // Agrupar canales
      groupedChannels = toGroup.reduce((acc, ch) => {
        const key = ch.group || "Sin grupo";
        if (!acc[key]) acc[key] = [];
        acc[key].push(ch);
        return acc;
      }, {});

      // Renderizar cada grupo
      let groupsRendered = 0;
      Object.entries(groupedChannels).forEach(([groupName, chList]) => {
        if (chList.length) {
          const groupElement = renderChannelGroup(groupName, chList);
          if (groupElement) {
            channelGroupsList.appendChild(groupElement);
            groupsRendered++;
          }
        }
      });

      if (!groupsRendered) {
        channelGroupsList.innerHTML = `<p>No se encontraron canales.</p>`;
      }
    }

    // Limpiar EPG
    function clearEpg() {
      clearElement(epgList);
    }

    // Mostrar error (alerta accesible)
    function showError(message) {
      alert(message);
    }

    // --- BÚSQUEDA ---

    // Filtrar canales por búsqueda y actualizar UI
    function filterChannels() {
      const query = searchInput.value.trim().toLowerCase();
      if (!query) {
        renderAllGroups();
        return;
      }
      const filtered = channels.filter(ch => ch.name.toLowerCase().includes(query));
      renderAllGroups(filtered);
    }

    const debouncedFilterChannels = debounce(filterChannels, 250);

    // --- CARGA DE ARCHIVOS Y FETCH ---

    // Leer archivo seleccionado y procesar
    function handleFileLoad(event) {
      const file = event.target.files[0];
      if (!file) return;

      // Validar tipo básico
      if (!file.name.endsWith(".m3u") && !file.type.includes("text")) {
        showError("Por favor seleccione un archivo M3U válido.");
        return;
      }

      toggleLoading(true);
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const text = e.target.result;
          const parsed = parseM3U(text);
          if (!parsed.length) throw new Error("Archivo M3U vacío o inválido.");
          channels = parsed;
          renderAllGroups();
          // Seleccionar primer canal
          if (channels.length) {
            setTimeout(() => {
              playChannel(channels[0], document.querySelector(".channel-card"));
            }, 100);
          }
        } catch (err) {
          showError(`Error al procesar archivo M3U: ${err.message}`);
        } finally {
          toggleLoading(false);
        }
      };
      reader.onerror = () => {
        toggleLoading(false);
        showError("Error al leer el archivo.");
      };
      reader.readAsText(file);
      // Reset input para poder cargar mismo archivo otra vez si desea
      event.target.value = "";
    }

    // Fetch archivo M3U por defecto y cargar
    async function loadDefaultM3U() {
      toggleLoading(true);
      try {
        const response = await fetch("./canales.m3u");
        if (!response.ok) throw new Error("No se pudo cargar canales.m3u");
        const text = await response.text();
        const parsed = parseM3U(text);
        if (!parsed.length) throw new Error("El archivo canales.m3u está vacío o es inválido.");
        channels = parsed;
        renderAllGroups();

        // Intentar cargar canal guardado
        const saved = readFromLocalStorage("selectedChannel", null);
        if (saved && saved.url) {
          // Buscar canal en lista por url para validar
          const found = channels.find(ch => ch.url === saved.url);
          if (found) {
            setTimeout(() => {
              const cards = [...document.querySelectorAll(".channel-card")];
              const cardToSelect = cards.find(card => card.querySelector(".card-title").textContent === found.name);
              if (cardToSelect) playChannel(found, cardToSelect);
              else playChannel(channels[0], document.querySelector(".channel-card"));
            }, 100);
          } else {
            playChannel(channels[0], document.querySelector(".channel-card"));
          }
        } else {
          playChannel(channels[0], document.querySelector(".channel-card"));
        }
      } catch (error) {
        showError(error.message);
      } finally {
        toggleLoading(false);
      }
    }

    // --- EPG (placeholder con fetch de ejemplo o simulación) ---

    // Simular fetch de programación (en realidad necesitas un API)
    async function fetchEpg(channelUrl) {
      // Aquí podrías hacer fetch a un API con programación real
      // Por ahora simulamos con datos dummy
      clearEpg();
      try {
        // Simulación de retardo
        await new Promise(r => setTimeout(r, 500));

        // Datos dummy (podrías personalizar)
        const dummyEpg = [
          { time: "10:00", title: "Programa 1" },
          { time: "11:00", title: "Programa 2" },
          { time: "12:00", title: "Programa 3" },
          { time: "13:00", title: "Programa 4" },
        ];

        dummyEpg.forEach(item => {
          const li = document.createElement("li");
          li.textContent = `${item.time} - ${item.title}`;
          epgList.appendChild(li);
        });
      } catch {
        // Mostrar mensaje en EPG
        epgList.innerHTML = "<li>No se pudo cargar la programación.</li>";
      }
    }

    // --- TEMA CLARO/OSCURO ---

    function applyTheme(theme) {
      if (theme === "dark") {
        document.documentElement.setAttribute("data-theme", "dark");
        themeToggleBtn.textContent = "☀️";
        themeToggleBtn.setAttribute("aria-pressed", "true");
      } else {
        document.documentElement.setAttribute("data-theme", "light");
        themeToggleBtn.textContent = "🌙";
        themeToggleBtn.setAttribute("aria-pressed", "false");
      }
      saveToLocalStorage("theme", theme);
    }

    function toggleTheme() {
      const current = document.documentElement.getAttribute("data-theme");
      applyTheme(current === "dark" ? "light" : "dark");
    }

    // --- INICIALIZACIÓN ---

    function init() {
      // Aplicar tema guardado o default
      const savedTheme = readFromLocalStorage("theme", "light");
      applyTheme(savedTheme);

      // Eventos
      searchInput.addEventListener("input", debouncedFilterChannels);
      themeToggleBtn.addEventListener("click", toggleTheme);
      fileInput.addEventListener("change", handleFileLoad);

      // Cargar canales por defecto
      loadDefaultM3U();
    }

    // Iniciar la app
    window.addEventListener("DOMContentLoaded", init);

  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
