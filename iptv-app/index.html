<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TV360 - En Vivo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <style>
    :root {
      --bg-color: #ffffff;
      --text-color: #333;
      --epg-bg: #f5f5f5;
      --highlight-color: #0d6efd;
      --card-bg: #fff;
      --card-text: #444;
      --nav-bg: #fff;
      --footer-bg: #f2f2f2;
    }
    [data-theme="dark"] {
      --bg-color: #121212;
      --text-color: #f1f1f1;
      --epg-bg: #1e1e1e;
      --highlight-color: #0d6efd;
      --card-bg: #2a2a2a;
      --card-text: #ccc;
      --nav-bg: #1a1a1a;
      --footer-bg: #1e1e1e;
    }
    body, html {
      margin: 0; padding: 0;
      background: var(--bg-color);
      color: var(--text-color);
      font-family: 'Segoe UI', sans-serif;
      transition: background 0.3s, color 0.3s;
    }
    nav.navbar { background: var(--nav-bg); }
    .navbar-brand { font-weight: bold; color: var(--highlight-color); }
    .form-control { background: var(--epg-bg); color: var(--text-color); border: none; border-radius: 20px; }
    .navbar-nav .nav-link { color: var(--text-color); }
    .navbar-nav .nav-link:hover { color: var(--highlight-color); }
    .theme-toggle-btn { background: none; border: none; font-size: 1.2rem; color: var(--text-color); cursor: pointer; }
    .container-main { padding: 1rem 2rem; }
    #epgContainer, #videoWrapper { height: 450px; }
    #epgContainer { background: var(--epg-bg); padding: 1rem; overflow-y: auto; }
    #epgContainer h5 { color: var(--highlight-color); font-weight: 600; border-bottom: 1px solid var(--highlight-color); padding-bottom: 0.5rem; }
    #epgList { list-style: none; padding: 0; margin: 0; }
    #epgList li { padding: 0.4rem 0; border-bottom: 1px solid var(--card-bg); }
    #videoWrapper { position: relative; background: black; overflow: hidden; }
    #livePlayer { width: 100%; height: 100%; object-fit: contain; background: black; }
    #loadingOverlay {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7); color: white;
      display: none; align-items: center; justify-content: center;
      font-size: 1.5rem; z-index: 10;
    }
    .channel-scroll { overflow-x: auto; white-space: nowrap; scrollbar-width: thin; scrollbar-color: var(--highlight-color) transparent; }
    .channel-card { display: inline-block; width: 140px; margin-right: 0.75rem; cursor: pointer; text-align: center; }
    .channel-card img { width: 140px; height: 84px; object-fit: cover; border-radius: 8px; background: var(--card-bg); }
    .card-title { margin-top: 0.5rem; font-size: 0.9rem; color: var(--card-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .channel-card:hover .card-title, .channel-card.active .card-title { color: var(--highlight-color); }
    footer.footer {
      background: var(--footer-bg); color: var(--text-color);
      padding: 1rem 2rem; text-align: center;
    }
    @media (max-width: 991.98px) {
      #epgContainer, #videoWrapper { height: auto; }
    }
  </style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg px-3">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">TV360</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMenu">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarMenu">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" href="#">Inicio</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Canales</a></li>
      </ul>
      <input class="form-control me-2 w-50" type="text" id="searchInput" placeholder="Buscar canal..." />
      <input type="file" id="m3uInput" accept=".m3u" class="form-control me-2" />
      <button class="theme-toggle-btn" id="themeToggleBtn" title="Alternar tema">🌙</button>
    </div>
  </div>
</nav>

<!-- CONTENIDO -->
<div class="container-fluid container-main">
  <div class="row">
    <div class="col-lg-4 col-12 mb-3">
      <div id="epgContainer">
        <h5>Programación</h5>
        <ul id="epgList"></ul>
      </div>
    </div>
    <div class="col-lg-8 col-12">
      <div id="videoWrapper">
        <div id="loadingOverlay">Cargando...</div>
        <video id="livePlayer" controls></video>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col-12">
      <div id="channelGroupsList"></div>
    </div>
  </div>
</div>

<!-- FOOTER -->
<footer class="footer">
  <div>© 2025 TV360. Todos los derechos reservados.</div>
  <div><a href="#">Privacidad</a> | <a href="#">Términos</a></div>
</footer>

<!-- SCRIPT -->
<script>
let channels = [], groupedChannels = {}, currentHls = null, currentChannelCard = null;

function applyTheme(theme) {
  document.documentElement.setAttribute("data-theme", theme);
  localStorage.setItem("tv360-theme", theme);
  document.getElementById("themeToggleBtn").textContent = theme === "dark" ? "☀️" : "🌙";
}
document.getElementById("themeToggleBtn").onclick = () => {
  const current = document.documentElement.getAttribute("data-theme");
  applyTheme(current === "dark" ? "light" : "dark");
};
applyTheme(localStorage.getItem("tv360-theme") || (window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light"));

async function parseM3U(text) {
  const lines = text.split("\n");
  const parsed = [];
  for (let i = 0; i < lines.length; i++) {
    if (lines[i].startsWith("#EXTINF")) {
      const name = (lines[i].match(/,(.*)$/) || [])[1] || "Canal";
      const logo = (lines[i].match(/tvg-logo="(.*?)"/) || [])[1] || "https://via.placeholder.com/140x84?text=Canal";
      const group = (lines[i].match(/group-title="(.*?)"/) || [])[1] || "Otros";
      const url = lines[i + 1]?.trim();
      if (url && url.startsWith("http"))
        parsed.push({
          name, logo, group, url,
          epg: [
            { time: "08:00", title: `Inicio de ${name}` },
            { time: "09:00", title: `Programa de ${name}` },
            { time: "10:00", title: `Más de ${name}` }
          ]
        });
    }
  }
  return parsed;
}

function groupChannels(chs) {
  const grouped = {};
  chs.forEach(ch => {
    if (!grouped[ch.group]) grouped[ch.group] = [];
    grouped[ch.group].push(ch);
  });
  return grouped;
}

function showEPG(channel) {
  const epgList = document.getElementById("epgList");
  epgList.innerHTML = "";
  channel.epg.forEach(item => {
    const li = document.createElement("li");
    li.textContent = `${item.time} — ${item.title}`;
    epgList.appendChild(li);
  });
}

function playChannel(channel, cardElem) {
  const video = document.getElementById("livePlayer");
  const overlay = document.getElementById("loadingOverlay");
  overlay.style.display = "flex";
  video.style.opacity = 0;

  if (currentHls) {
    currentHls.destroy();
    currentHls = null;
  }

  if (Hls.isSupported()) {
    const hls = new Hls();
    hls.loadSource(channel.url);
    hls.attachMedia(video);
    hls.on(Hls.Events.MANIFEST_PARSED, () => {
      video.play();
      setTimeout(() => {
        video.style.opacity = 1;
        overlay.style.display = "none";
      }, 300);
    });
    hls.on(Hls.Events.ERROR, (event, data) => {
      if (data.fatal) {
        alert("Error de reproducción. Intenta otro canal.");
        overlay.style.display = "none";
      }
    });
    currentHls = hls;
  } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
    video.src = channel.url;
    video.oncanplay = () => {
      video.play();
      setTimeout(() => {
        video.style.opacity = 1;
        overlay.style.display = "none";
      }, 300);
    };
  } else {
    alert("Tu navegador no soporta HLS.");
    overlay.style.display = "none";
  }

  if (currentChannelCard) currentChannelCard.classList.remove("active");
  if (cardElem) {
    cardElem.classList.add("active");
    currentChannelCard = cardElem;
  }

  showEPG(channel);
}

function buildChannelGroupsUI() {
  const container = document.getElementById("channelGroupsList");
  container.innerHTML = "";
  for (const group in groupedChannels) {
    const block = document.createElement("div");
    const title = document.createElement("div");
    title.className = "fw-bold text-primary mb-2";
    title.textContent = group;
    const scroll = document.createElement("div");
    scroll.className = "channel-scroll mb-3";
    groupedChannels[group].forEach(channel => {
      const card = document.createElement("div");
      card.className = "channel-card";
      card.setAttribute("data-name", channel.name.toLowerCase());
      card.onclick = () => playChannel(channel, card);
      card.innerHTML = `<img src="${channel.logo}" alt="${channel.name}"><div class="card-title">${channel.name}</div>`;
      scroll.appendChild(card);
    });
    block.appendChild(title);
    block.appendChild(scroll);
    container.appendChild(block);
  }
}

document.getElementById("searchInput").addEventListener("input", function () {
  const query = this.value.toLowerCase();
  document.querySelectorAll(".channel-card").forEach(card => {
    card.style.display = card.getAttribute("data-name").includes(query) ? "inline-block" : "none";
  });
});

document.getElementById("m3uInput").addEventListener("change", async function () {
  const file = this.files[0];
  if (!file) return;
  const text = await file.text();
  channels = await parseM3U(text);
  if (channels.length === 0) return alert("Archivo inválido.");
  groupedChannels = groupChannels(channels);
  buildChannelGroupsUI();
  const first = groupedChannels[Object.keys(groupedChannels)[0]][0];
  const firstCard = [...document.querySelectorAll(".channel-card")].find(c => c.getAttribute("data-name") === first.name.toLowerCase());
  playChannel(first, firstCard);
});

// Cargar canal inicial (opcional)
// Puedes incluir canales predeterminados si lo deseas aquí
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
