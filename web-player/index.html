<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IPTV + EPG con Video.js</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Video.js CSS -->
  <link href="https://vjs.zencdn.net/8.21.0/video-js.css" rel="stylesheet" />

  <style>
    .channel-card {
      cursor: pointer;
      transition: transform 0.2s;
    }
    .channel-card:hover {
      transform: scale(1.02);
    }
    .video-js {
      width: 100% !important;
      height: 480px !important;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand" href="#">TV360</a>
      <input class="form-control ms-auto w-50" type="text" id="searchInput" placeholder="Buscar canal..." />
    </div>
  </nav>

  <div class="container mt-4">
    <div class="row">
      <div class="col-lg-8">
        <h5 id="currentChannelTitle">Selecciona un canal para reproducir</h5>
        <video
          id="livePlayer"
          class="video-js vjs-default-skin"
          controls
          preload="auto"
          data-setup='{}'
          playsinline
        ></video>
      </div>
      <div class="col-lg-4">
        <h5>Guía de Programación</h5>
        <ul class="list-group" id="epgList">
          <li class="list-group-item">Selecciona un canal</li>
        </ul>
        <div class="mt-3">
          <h6>Ahora en vivo</h6>
          <div id="nowProgramme">—</div>
        </div>
      </div>
    </div>
  </div>

  <div class="container mt-5">
    <h5>Canales</h5>
    <div class="row" id="channelGrid"></div>
  </div>

  <footer class="bg-dark text-white text-center py-3 mt-5">
    <div class="container">&copy; 2025 TV360</div>
  </footer>

  <!-- Video.js -->
  <script src="https://vjs.zencdn.net/8.21.0/video.min.js"></script>
  <!-- HLS support for Video.js -->
  <script src="https://cdn.jsdelivr.net/npm/videojs-http-streaming@2.14.0/dist/videojs-http-streaming.min.js"></script>

  <script>
    let channels = [];
    let epgData = {};
    let filteredChannels = [];
    let player = null;

    // Función para parsear M3U
    function parseM3U(text) {
      const lines = text.split(/\r?\n/);
      const chs = [];
      let current = null;

      lines.forEach(line => {
        line = line.trim();
        if (!line) return;
        if (line.startsWith('#EXTINF')) {
          const nameMatch = line.match(/,(.+)$/);
          const idMatch = line.match(/tvg-id="([^"]+)"/);
          const logoMatch = line.match(/tvg-logo="([^"]+)"/);

          current = {
            id: idMatch ? idMatch[1] : null,
            name: nameMatch ? nameMatch[1].trim() : 'Sin nombre',
            logo: logoMatch ? logoMatch[1] : null,
            url: null
          };
        } else if (line.startsWith('http') || line.startsWith('udp')) {
          if (current) {
            current.url = line;
            chs.push(current);
            current = null;
          }
        }
      });

      return chs;
    }

    // Función para parsear XMLTV (EPG)
    function parseEPG(xmlText) {
      const parser = new DOMParser();
      const xml = parser.parseFromString(xmlText, 'text/xml');
      const programmes = xml.querySelectorAll('programme');
      const epgMap = {};

      programmes.forEach(prog => {
        const ch = prog.getAttribute('channel');
        const startStr = prog.getAttribute('start');
        const stopStr = prog.getAttribute('stop');
        const titleEl = prog.querySelector('title');
        const title = titleEl ? titleEl.textContent : 'Sin título';

        const start = parseXMLTVTime(startStr);
        const stop = parseXMLTVTime(stopStr);

        if (!epgMap[ch]) epgMap[ch] = [];
        epgMap[ch].push({ start, stop, title });
      });

      return epgMap;
    }

    function parseXMLTVTime(timeStr) {
      let ts = timeStr.trim();
      let tz = '';
      const tzMatch = ts.match(/([+-]\d{4})$/);
      if (tzMatch) {
        tz = tzMatch[1];
        ts = ts.replace(/([+-]\d{4})$/, '');
      } else if (ts.endsWith('Z')) {
        tz = 'Z';
        ts = ts.slice(0, -1);
      }

      const year = parseInt(ts.substring(0,4));
      const month = parseInt(ts.substring(4,6)) - 1;
      const day = parseInt(ts.substring(6,8));
      const hour = parseInt(ts.substring(8,10));
      const minute = parseInt(ts.substring(10,12));
      const second = parseInt(ts.substring(12,14));

      let date;
      if (tz === 'Z' || tz === '') {
        date = new Date(Date.UTC(year, month, day, hour, minute, second));
      } else {
        const sign = tz[0];
        const tzHour = parseInt(tz.substring(1,3));
        const tzMin = parseInt(tz.substring(3,5));
        const offset = (tzHour * 60 + tzMin) * (sign === '+' ? 1 : -1);
        date = new Date(Date.UTC(year, month, day, hour, minute, second) - offset * 60000);
      }
      return date;
    }

    async function loadFiles() {
      try {
        const [m3uResp, epgResp] = await Promise.all([
          fetch('iptv.m3u'),
          fetch('epg.xml')
        ]);

        const m3uText = await m3uResp.text();
        const epgText = await epgResp.text();

        channels = parseM3U(m3uText);
        epgData = parseEPG(epgText);
        filteredChannels = channels;

        renderChannels(filteredChannels);
      } catch (e) {
        alert('Error cargando archivos: ' + e);
      }
    }

    function renderChannels(chList) {
      const grid = document.getElementById('channelGrid');
      grid.innerHTML = '';
      if (chList.length === 0) {
        grid.innerHTML = '<p>No se encontraron canales.</p>';
        return;
      }
      chList.forEach(ch => {
        const col = document.createElement('div');
        col.className = 'col-6 col-md-4 col-lg-3 mb-4';

        const card = document.createElement('div');
        card.className = 'card channel-card';
        card.onclick = () => selectChannel(ch);

        const img = document.createElement('img');
        img.src = ch.logo || 'https://via.placeholder.com/120x60?text=No+Logo';
        img.className = 'card-img-top';
        img.alt = ch.name;

        const body = document.createElement('div');
        body.className = 'card-body p-2';

        const title = document.createElement('h6');
        title.className = 'card-title mb-0';
        title.textContent = ch.name;

        body.appendChild(title);
        card.appendChild(img);
        card.appendChild(body);
        col.appendChild(card);
        grid.appendChild(col);
      });
    }

    function selectChannel(ch) {
      if (!player) {
        player = videojs('livePlayer');
      }
      player.src({
        src: ch.url,
        type: 'application/x-mpegURL'
      });
      player.play();

      document.getElementById('currentChannelTitle').textContent = `Reproduciendo: ${ch.name}`;

      renderEPG(ch.id);
      renderNow(ch.id);
    }

    function renderEPG(channelId) {
      const epgList = document.getElementById('epgList');
      epgList.innerHTML = '';

      const programmes = epgData[channelId] || [];

      if (programmes.length === 0) {
        epgList.innerHTML = '<li class="list-group-item">No hay guía disponible</li>';
        return;
      }

      programmes.forEach(prog => {
        const li = document.createElement('li');
        li.className = 'list-group-item';

        const start = prog.start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const stop = prog.stop.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        li.textContent = `${start} - ${stop} : ${prog.title}`;
        epgList.appendChild(li);
      });
    }

    function renderNow(channelId) {
      const nowDiv = document.getElementById('nowProgramme');
      const programmes = epgData[channelId] || [];
      const now = new Date();
      const currentProg = programmes.find(p => now >= p.start && now < p.stop);

      if (currentProg) {
        const start = currentProg.start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const stop = currentProg.stop.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        nowDiv.textContent = `${start} - ${stop}: ${currentProg.title}`;
      } else {
        nowDiv.textContent = 'No hay programa en emisión';
      }
    }

    document.getElementById('searchInput').addEventListener('input', (e) => {
      const q = e.target.value.toLowerCase();
      filteredChannels = channels.filter(ch => ch.name.toLowerCase().includes(q));
      renderChannels(filteredChannels);
    });

    loadFiles();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/videojs-contrib-hls@5.15.0/dist/videojs-contrib-hls.min.js"></script>

  <script>
    player = videojs('livePlayer', {
      html5: {
        hls: {
          overrideNative: true
        }
      }
    });

  </script>

</body>
</html>
